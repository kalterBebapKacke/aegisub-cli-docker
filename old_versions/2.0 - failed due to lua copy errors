FROM ubuntu:22.04 AS builder

# Combine RUN commands and clean up in same layer
RUN apt-get update \
    && apt-get install -y python3-pip python3 git cmake pkg-config ninja-build build-essential \
    libx11-dev libwxgtk3.0-gtk3-dev libfreetype6-dev pkg-config \
    libfontconfig1-dev libass-dev libasound2-dev libffms2-dev intltool \
    libboost-all-dev libhunspell-dev libuchardet-dev libpulse-dev \
    libopenal-dev libxxhash-dev nasm lua5.1 liblua5.1-0-dev liblua5.1-0  luarocks libcurl4-gnutls-dev \
    ffmsindex libreadline8 libreadline-dev \
    libgtk2.0-dev libgtk-3-dev mesa-utils freeglut3-dev libjpeg-dev liblzma-dev\
    libwxgtk3.0-gtk3-0v5 libwxbase3.0-0v5 libwxgtk3.0-gtk3-0v5 \
    && python3 -m pip install --upgrade pip setuptools meson \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Build Aegisub
WORKDIR /build
RUN git clone https://github.com/arch1t3cht/Aegisub.git -b feature_12 \
    && cd Aegisub \
    && meson setup build --prefix=/usr --buildtype=release \
    && meson compile -C build \
    && cd build \
    && ninja install

# Install Lua dependencies
RUN luarocks --lua-version=5.1 install luajson 1.3.3-1 \
 && luarocks --lua-version=5.1 install moonscript \
 && luarocks --lua-version=5.1 install luafilesystem

# Install Dependancies for wxWidgets

# Build wxWidgets
WORKDIR /build/wx
RUN curl -LJO https://github.com/wxWidgets/wxWidgets/releases/download/v3.0.5/wxWidgets-3.0.5.tar.bz2 \
    && tar -xf wxWidgets-3.0.5.tar.bz2 \
    && cd wxWidgets-3.0.5 \
    && mkdir gtk-build \
    && cd gtk-build \
    && ../configure --with-gtk=3 --with-opengl --disable-debug --enable-optimise \
    && make -j$(nproc) \
    && make install \
    && ldconfig \
    && cd /build && rm -rf wx

# Build Aegisub-cli
RUN python3 -m pip install meson==0.62 # Downgrade Meson due to sandbox violation (known issue)
WORKDIR /build
COPY ./src/fs.cpp /tmp/fs.cpp
RUN git clone https://github.com/Myaamori/aegisub-cli \
    && cd aegisub-cli \
    && rm libaegisub/common/fs.cpp \
    && mv /tmp/fs.cpp libaegisub/common/ \
    && meson --prefix=/usr --buildtype=release build  \
    && meson compile -C build src/aegisub-cli \
    && mv build/src/aegisub-cli /usr/local/bin/ \
    && mv build/src/libresrc/libresrc.a /usr/local/lib/ \
    && mv build/src/libresrc/default_config.h /usr/local/include/

# Setup automation scripts
WORKDIR /build/automation
COPY ../scripts ./scripts/
COPY ../src/Logger.moon ./Logger.moon
COPY ./src/l0.DependencyControl.json ./l0.DependencyControl.json

# Download and setup DependencyControl
RUN curl -L https://github.com/RellikJaeger/DependencyControl/releases/download/v0.6.4-alpha/DependencyControl-v0.6.4-Linux-amd64.tar.gz \
    | tar -xz \
    && rm -f DependencyControl-v0.6.4-Linux-amd64/include/l0/DependencyControl/Logger.moon \
    && cp Logger.moon DependencyControl-v0.6.4-Linux-amd64/include/l0/DependencyControl/

# Build SubInspector
RUN git clone https://github.com/TypesettingTools/SubInspector.git \
    && cd SubInspector \
    && meson build \
    && cd build \
    && ninja

# Runtime stage
FROM ubuntu:22.04 AS runtime

# Install only runtime dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    libwxgtk3.0-gtk3-0v5 libwxbase3.0-0v5 \
    libx11-6 libfreetype6 libfontconfig1 libass9 libasound2 \
    libboost-filesystem1.74.0 libboost-locale1.74.0 libboost-regex1.74.0 \
    libhunspell-1.7-0 libuchardet0 libpulse0 libopenal1 \
    libcurl3-gnutls \
    libffms2-5 libboost-program-options1.74.0 libboost-filesystem1.74.0 libboost-system1.74.0 libboost-chrono1.74.0 \
    fonts-liberation fonts-dejavu fontconfig \
    xvfb \
    liblua5.1-dev luarocks lua5.1 git liblua5.1-0 \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Copy built artifacts from builder stage
COPY --from=builder /usr/local/bin/aegisub-cli /usr/local/bin/
COPY --from=builder /usr/bin/aegisub /usr/bin/
COPY --from=builder /usr/bin/* /usr/bin/
COPY --from=builder /usr/local/bin/* /usr/local/bin/
#COPY --from=builder /usr/local/bin/Xvfb /usr/local/bin/
#COPY --from=builder /usr/local/bin/xvfb-run /usr/local/bin/
COPY --from=builder /usr/local/share/lua/* /usr/local/share/lua/
COPY --from=builder /usr/share/aegisub/* /usr/share/aegisub/

COPY --from=builder /usr/local/lib/libresrc.a /usr/local/lib/
#COPY --from=builder /usr/local/lib/* /usr/local/lib/
COPY --from=builder /usr/local/include/default_config.h /usr/local/include/

# Copy lua related stuff
#COPY --from=builder /usr/local/lib/lua/5.1/ /usr/local/lib/lua/5.1/
#COPY --from=builder /usr/local/share/lua/5.1/ /usr/local/share/lua/5.1/
#COPY --from=builder /usr/local/lib/ /usr/local/lib/
COPY --from=builder /usr/local/lib/liblua* /usr/local/lib/
COPY --from=builder /usr/lib/x86_64-linux-gnu/liblua* /usr/lib/x86_64-linux-gnu/

RUN luarocks --lua-version=5.1 install luajson 1.3.3-1 \
 && luarocks --lua-version=5.1 install moonscript


#COPY --from=builder /usr/local/lib/liblua* /usr/local/lib/
RUN ldconfig

# Setup Aegisub directories
ARG HOME='/root'
RUN mkdir -p ${HOME}/.aegisub/automation/include/SubInspector/Inspector \
    && mkdir -p ${HOME}/.aegisub/config/ \
    && mkdir -p ${HOME}/.aegisub/log

# Copy automation setup
COPY --from=builder /build/automation/scripts/ ${HOME}/.aegisub/automation/autoload/
COPY --from=builder /build/automation/DependencyControl-v0.6.4-Linux-amd64/ ${HOME}/.aegisub/automation/
COPY --from=builder /build/automation/SubInspector/examples/Aegisub/Inspector.moon ${HOME}/.aegisub/automation/include/SubInspector/
COPY --from=builder /build/automation/SubInspector/build/src/libSubInspector.so ${HOME}/.aegisub/automation/include/SubInspector/Inspector/
COPY --from=builder /build/automation/l0.DependencyControl.json ${HOME}/.aegisub/config/

RUN ldconfig

WORKDIR /home

# Copy input file
COPY ../input.ass .

RUN ldd /usr/local/lib/lua/5.1/lfs.so
#RUN nm -D /usr/local/bin/aegisub-cli | grep lua_gettop

RUN aegisub-cli --automation l0.DependencyControl.Toolbox.moon --dialog '{"button":0,"values":{"macro":"DependencyControl"}}' --loglevel 4 input.ass dummy_out.ass "DependencyControl/Install Script"

# Pre-install dependencies
#RUN xvfb-run -a -s "-screen 0 1024x768x16" aegisub-cli --automation l0.DependencyControl.Toolbox.moon --dialog '{"button":0,"values":{"macro":"DependencyControl"}}' --loglevel 4 input.ass dummy_out.ass "DependencyControl/Install Script" \
#    && xvfb-run -a -s "-screen 0 1024x768x16" aegisub-cli --automation l0.DependencyControl.Toolbox.moon --dialog '{"button": 0, "values": {"macro":"Shapery v2.6.1"}}' --loglevel 4 input.ass dummy_out.ass "DependencyControl/Install Script"